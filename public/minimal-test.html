<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Test - Cown</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
        }
        input, button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
    </style>
</head>
<body>
    <h1>Minimal OTP Test</h1>
    
    <div id="phoneStep">
        <h3>1. Gửi OTP</h3>
        <input type="tel" id="phoneInput" placeholder="+84999111222" value="+84999111222">
        <button id="sendBtn">Gửi OTP</button>
    </div>

    <div id="otpStep" style="display: none;">
        <h3>2. Xác thực OTP</h3>
        <input type="text" id="otpInput" placeholder="000000" maxlength="6">
        <button id="verifyBtn">Xác thực</button>
        <button id="backBtn">Quay lại</button>
    </div>

    <div id="message"></div>

    <script>
        class MinimalOTP {
            constructor() {
                this.phoneInput = document.getElementById('phoneInput');
                this.otpInput = document.getElementById('otpInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.verifyBtn = document.getElementById('verifyBtn');
                this.backBtn = document.getElementById('backBtn');
                this.message = document.getElementById('message');
                this.phoneStep = document.getElementById('phoneStep');
                this.otpStep = document.getElementById('otpStep');
                
                this.setupEvents();
            }

            setupEvents() {
                this.sendBtn.addEventListener('click', () => this.sendOTP());
                this.verifyBtn.addEventListener('click', () => this.verifyOTP());
                this.backBtn.addEventListener('click', () => this.showPhoneStep());
            }

            showMessage(text, type = 'info') {
                this.message.innerHTML = text;
                this.message.className = `message ${type}`;
                this.message.style.display = 'block';
            }

            hideMessage() {
                this.message.style.display = 'none';
            }

            showPhoneStep() {
                this.phoneStep.style.display = 'block';
                this.otpStep.style.display = 'none';
                this.hideMessage();
            }

            showOTPStep() {
                this.phoneStep.style.display = 'none';
                this.otpStep.style.display = 'block';
                this.otpInput.focus();
            }

            async sendOTP() {
                const phone = this.phoneInput.value.trim();
                if (!phone) {
                    this.showMessage('Vui lòng nhập số điện thoại', 'error');
                    return;
                }

                this.sendBtn.disabled = true;
                this.sendBtn.textContent = 'Đang gửi...';
                this.hideMessage();

                try {
                    console.log('📞 Sending OTP to:', phone);
                    const response = await fetch('/api/auth/send-phone-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone: phone }),
                        credentials: 'include'
                    });

                    const result = await response.json();
                    console.log('📡 Response:', result);

                    if (response.ok && result.success) {
                        const method = result.method === 'telegram' ? 'Telegram' : 'SMS';
                        this.showMessage(`✅ Mã OTP đã gửi qua ${method}`, 'success');
                        setTimeout(() => this.showOTPStep(), 1000);
                    } else {
                        this.showMessage(`❌ ${result.error || 'Không thể gửi OTP'}`, 'error');
                    }
                } catch (error) {
                    console.error('❌ Send OTP error:', error);
                    this.showMessage('❌ Lỗi kết nối. Kiểm tra mạng và thử lại.', 'error');
                } finally {
                    this.sendBtn.disabled = false;
                    this.sendBtn.textContent = 'Gửi OTP';
                }
            }

            async verifyOTP() {
                const phone = this.phoneInput.value.trim();
                const otp = this.otpInput.value.trim();
                
                if (!otp || otp.length !== 6) {
                    this.showMessage('Vui lòng nhập mã OTP 6 số', 'error');
                    return;
                }

                this.verifyBtn.disabled = true;
                this.verifyBtn.textContent = 'Đang xác thực...';
                this.hideMessage();

                try {
                    console.log('🔐 Verifying OTP:', otp, 'for phone:', phone);
                    const response = await fetch('/api/auth/login-with-phone', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone: phone, otp: otp }),
                        credentials: 'include'
                    });

                    const result = await response.json();
                    console.log('🔐 Verify response:', result);

                    if (response.ok && result.success) {
                        this.showMessage('✅ Đăng nhập thành công!', 'success');
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1500);
                    } else {
                        this.showMessage(`❌ ${result.error || 'Mã OTP không đúng'}`, 'error');
                    }
                } catch (error) {
                    console.error('❌ Verify OTP error:', error);
                    this.showMessage('❌ Lỗi kết nối. Kiểm tra mạng và thử lại.', 'error');
                } finally {
                    this.verifyBtn.disabled = false;
                    this.verifyBtn.textContent = 'Xác thực';
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Minimal OTP Test initialized');
            window.minimalOTP = new MinimalOTP();
        });
    </script>
</body>
</html>
